version: 0.2

env:
  variables:
    PYTHON_VERSION: "3.10"
    MODEL_NAME: "NickLamb/Mistral-7B-Instruct-v0.3"
    MODEL_FILE: "Mistral-7B-Instruct-v0.3.Q4_K_M.gguf"
    HF_TOKEN: ${HF_TOKEN}

phases:
  install:
    runtime-versions:
      python: 3.10
    commands:
      - echo "🔧 Installing required Python packages..."
      - pip install --upgrade pip
      - pip install instructlab gitpython gradio sentence_transformers langchain_community tqdm huggingface_hub pypdf langchain faiss-cpu torch transformers langchain_text_splitters
      - echo "✅ Dependencies installed successfully"
      - pip list
      - echo "📦 Above is the list of installed packages"

  pre_build:
    commands:
      - echo "📥 Downloading ${MODEL_FILE} model..."
      - ilab model download --repository=${MODEL_NAME} --filename=${MODEL_FILE}
      - echo "✅ Model downloaded successfully"
      - echo "🚀 Starting InstructLab server..."
      - nohup ilab model serve > server.log 2>&1 &
      - echo "⏳ Waiting for server to start..."
      - sleep 20
      - echo "✅ Server started successfully"
      - echo "🚀 Initializing RAG system..."
      - python .github/workflows/rag_system.py
      - echo "✅ RAG system initialized and running"

  build:
    commands:
      - echo "🗂️ Creating directory for converted files..."
      - mkdir -p converted_files
      - echo "✅ Directory created - converted_files"
      - echo "🔍 Finding changed Python files..."
