name: Convert Python to C# and Create PR

on:
  push:
    branches: [main]
    paths:
      - '**.py'

env:
  PYTHON_VERSION: '3.10'
  MODEL_REPO: 'lmstudio-community/Mistral-7B-Instruct-v0.3-GGUF'
  MODEL_FILE: 'Mistral-7B-Instruct-v0.3-Q4_K_M.gguf'

jobs:
  convert_and_pr:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Python repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
      
    - name: Get commit message
      run: |
        echo "ðŸ“œ Retrieving commit message for SHA: ${{ github.sha }}"
        COMMIT_MESSAGE=$(git log --format=%B -n 1 "${{ github.sha }}")
        {
          echo "COMMIT_MESSAGE<<EOF"
          echo "$COMMIT_MESSAGE"
          echo "EOF"
        } >> "$GITHUB_ENV"
        echo "âœ… Commit message retrieved and stored in environment variable"

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Print content of changed file
      run: |
        echo "ðŸ“„ Printing content of changed file(s):"
        git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep '\.py$' | while read file; do
          echo "File: $file"
          echo "=========================="
          cat "$file"
          echo "=========================="
          echo ""
        done

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install transformers torch sentencepiece huggingface_hub

    - name: Download Mistral 7B v0.3 model file
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python -c "from huggingface_hub import hf_hub_download; hf_hub_download(repo_id='${{ env.MODEL_REPO }}', filename='${{ env.MODEL_FILE }}', use_auth_token='${{ secrets.HF_TOKEN }}')"

    - name: Convert Python to C#
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep '\.py$' | while read file; do
          echo "Converting $file to C#"
          python_code=$(cat "$file")
          output_file="${file%.py}.cs"
          
          python - <<EOF
        from transformers import AutoTokenizer, AutoModelForCausalLM
        import torch
        model_name = "${{ env.MODEL_REPO }}"
        model_file = "${{ env.MODEL_FILE }}"
        tokenizer = AutoTokenizer.from_pretrained(model_name, token="${{ secrets.HF_TOKEN }}")
        model = AutoModelForCausalLM.from_pretrained(model_file, token="${{ secrets.HF_TOKEN }}")
        prompt = f"Convert the following Python code to C#:\n\n{python_code}\n\nC# code:"
        input_ids = tokenizer.encode(prompt, return_tensors="pt")
        
        with torch.no_grad():
            output = model.generate(input_ids, max_length=2048, num_return_sequences=1, temperature=0.7)
        
        csharp_code = tokenizer.decode(output[0], skip_special_tokens=True)
        print(csharp_code)
        EOF
          
          echo "$csharp_code" > "$output_file"
          echo "Converted $file to $output_file"
        done
